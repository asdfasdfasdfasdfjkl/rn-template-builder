name: Build React Native Android App

on:
  workflow_dispatch:
    inputs:
      build_id:
        description: 'Build ID'
        required: true
        type: string
      app_name:
        description: 'App Name'
        required: true
        type: string
      build_type:
        description: 'Build Type'
        required: false
        default: 'release'
        type: choice
        options:
          - release
          - debug
      output_type:
        description: 'Output Type'
        required: false
        default: 'apk'
        type: choice
        options:
          - apk
          - aab
      platform:
        description: 'Platform'
        required: false
        default: 'android'
        type: string

env:
  BUILD_ID: ${{ github.event.inputs.build_id }}
  APP_NAME: ${{ github.event.inputs.app_name }}
  BUILD_TYPE: ${{ github.event.inputs.build_type || 'release' }}
  OUTPUT_TYPE: ${{ github.event.inputs.output_type || 'apk' }}
  PLATFORM: ${{ github.event.inputs.platform || 'android' }}

jobs:
  build-android:
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Read build configuration
        id: config
        run: |
          echo "Loading build configuration..."
          if [ -f "build-config.json" ]; then
            CONFIG=$(cat build-config.json)
            WEBSITE_ADDRESS=$(echo $CONFIG | jq -r '.website_address // "https://example.com"')
            VERSION_CODE=$(echo $CONFIG | jq -r '.version_code // "1"')
            VERSION_NAME=$(echo $CONFIG | jq -r '.version_name // "1.0.0"')
            NAME_SPACE=$(echo $CONFIG | jq -r '.name_space // "com.example.app"')
            APP_ICON=$(echo $CONFIG | jq -r '.app_icon // "null"')
            HAS_CUSTOM_ICON=$(echo $CONFIG | jq -r '.has_custom_icon // "false"')
            
            # Extract permissions with defaults
            CAMERA_PERMISSION=$(echo $CONFIG | jq -r '.permissions.camera // "disabled"')
            LOCATION_PERMISSION=$(echo $CONFIG | jq -r '.permissions.location // "disabled"')
            MICROPHONE_PERMISSION=$(echo $CONFIG | jq -r '.permissions.microphone // "disabled"')
            NOTIFICATIONS_PERMISSION=$(echo $CONFIG | jq -r '.permissions.notifications // "disabled"')
            CONTACTS_PERMISSION=$(echo $CONFIG | jq -r '.permissions.contacts // "disabled"')
            
            echo "WEBSITE_ADDRESS=$WEBSITE_ADDRESS" >> $GITHUB_ENV
            echo "VERSION_CODE=$VERSION_CODE" >> $GITHUB_ENV
            echo "VERSION_NAME=$VERSION_NAME" >> $GITHUB_ENV
            echo "NAME_SPACE=$NAME_SPACE" >> $GITHUB_ENV
            echo "APP_ICON=$APP_ICON" >> $GITHUB_ENV
            echo "HAS_CUSTOM_ICON=$HAS_CUSTOM_ICON" >> $GITHUB_ENV
            echo "CAMERA_PERMISSION=$CAMERA_PERMISSION" >> $GITHUB_ENV
            echo "LOCATION_PERMISSION=$LOCATION_PERMISSION" >> $GITHUB_ENV
            echo "MICROPHONE_PERMISSION=$MICROPHONE_PERMISSION" >> $GITHUB_ENV
            echo "NOTIFICATIONS_PERMISSION=$NOTIFICATIONS_PERMISSION" >> $GITHUB_ENV
            echo "CONTACTS_PERMISSION=$CONTACTS_PERMISSION" >> $GITHUB_ENV
            
            echo "Configuration loaded:"
            echo "  Website: $WEBSITE_ADDRESS"
            echo "  Version Code: $VERSION_CODE"
            echo "  Version Name: $VERSION_NAME"
            echo "  Namespace: $NAME_SPACE"
            echo "  Has Custom Icon: $HAS_CUSTOM_ICON"
            echo "  Permissions:"
            echo "    Camera: $CAMERA_PERMISSION"
            echo "    Location: $LOCATION_PERMISSION"
            echo "    Microphone: $MICROPHONE_PERMISSION"
            echo "    Notifications: $NOTIFICATIONS_PERMISSION"
            echo "    Contacts: $CONTACTS_PERMISSION"
          else
            echo "Error: build-config.json not found!"
            exit 1
          fi

      - name: Apply template customizations
        shell: bash
        run: |
          echo "Applying template customizations..."
          
          # Extract middle segment from namespace for settings.gradle and app.json
          NAME_SPACE_PARTS=(${NAME_SPACE//./ })
          if [ ${#NAME_SPACE_PARTS[@]} -ge 3 ]; then
            MIDDLE_SEGMENT=${NAME_SPACE_PARTS[1]}
          else
            MIDDLE_SEGMENT=${NAME_SPACE_PARTS[-1]}
          fi
          
          echo "Using middle segment: $MIDDLE_SEGMENT"
          
          # Function to safely replace content in files
          safe_replace() {
            local file=$1
            local find=$2
            local replace=$3
          
            if [ -f "$file" ]; then
              perl -i -pe '
                BEGIN {
                  ($find, $replace) = @ARGV;
                  shift; shift;  # drop them, leave only filenames
                }
                s/\Q$find\E/$replace/g;
              ' "$find" "$replace" "$file"
              echo "✓ Updated $file: $find -> $replace"
            else
              echo "✗ File not found: $file"
            fi
          }


          
          # Apply all replacements matching the working local build
          safe_replace "android/settings.gradle" "rn_project_template" "$MIDDLE_SEGMENT"
          safe_replace "app.json" "rn_project_template" "$MIDDLE_SEGMENT"
          safe_replace "android/app/src/main/java/com/rn_project_template/MainActivity.kt" '"rn_project_template"' "\"$MIDDLE_SEGMENT\""
          safe_replace "android/app/src/main/java/com/rn_project_template/MainActivity.kt" "{{name_space}}" "$NAME_SPACE"
          safe_replace "App.tsx" "{{website_address}}" "$WEBSITE_ADDRESS"
          safe_replace "app.json" "{{app_name}}" "$APP_NAME"
          safe_replace "android/app/build.gradle" "{{version_code}}" "$VERSION_CODE"
          safe_replace "android/app/src/main/res/values/strings.xml" "rn_project_template" "$APP_NAME"
          safe_replace "android/app/build.gradle" "{{version_name}}" "$VERSION_NAME"
          safe_replace "android/app/build.gradle" "com.rn_project_template" "$NAME_SPACE"
          safe_replace "android/app/src/main/java/com/rn_project_template/MainActivity.kt" "com.rn_project_template" "$NAME_SPACE"
          safe_replace "android/app/src/main/java/com/rn_project_template/MainApplication.kt" "com.rn_project_template" "$NAME_SPACE"
          safe_replace "android/app/src/main/AndroidManifest.xml" "{{name_space}}" "$NAME_SPACE"
          
          echo "Template customizations applied successfully"

      - name: Generate permission configuration
        run: |
          echo "Generating permission configuration..."
          
          # Create permissionConfig.js
          cat > permissionConfig.js << EOF
          // Auto-generated permission configuration
          export const PERMISSION_CONFIG = {
            camera: ${{ env.CAMERA_PERMISSION == 'enabled' && 'true' || 'false' }},
            location: ${{ env.LOCATION_PERMISSION == 'enabled' && 'true' || 'false' }},
            microphone: ${{ env.MICROPHONE_PERMISSION == 'enabled' && 'true' || 'false' }},
            notifications: ${{ env.NOTIFICATIONS_PERMISSION == 'enabled' && 'true' || 'false' }},
            contacts: ${{ env.CONTACTS_PERMISSION == 'enabled' && 'true' || 'false' }}
          };
          EOF
          
          echo "✓ Permission configuration generated"

      - name: Update Android manifest with permissions
        run: |
          echo "Updating AndroidManifest.xml with required permissions..."
          MANIFEST_PATH="android/app/src/main/AndroidManifest.xml"
          
          if [ -f "$MANIFEST_PATH" ]; then
            echo "Original AndroidManifest.xml:"
            head -20 "$MANIFEST_PATH"
            
            # Create a backup
            cp "$MANIFEST_PATH" "${MANIFEST_PATH}.backup"
            
            # Build permissions directly without \n escape sequences
            PERMISSIONS_FILE="/tmp/permissions.txt"
            > "$PERMISSIONS_FILE"  # Clear file
            
            if [ "${{ env.CAMERA_PERMISSION }}" == "enabled" ]; then
              echo "    <uses-permission android:name=\"android.permission.CAMERA\" />" >> "$PERMISSIONS_FILE"
              echo "✓ Adding CAMERA permission"
            fi
            
            if [ "${{ env.LOCATION_PERMISSION }}" == "enabled" ]; then
              echo "    <uses-permission android:name=\"android.permission.ACCESS_FINE_LOCATION\" />" >> "$PERMISSIONS_FILE"
              echo "    <uses-permission android:name=\"android.permission.ACCESS_COARSE_LOCATION\" />" >> "$PERMISSIONS_FILE"
              echo "✓ Adding LOCATION permissions"
            fi
            
            if [ "${{ env.MICROPHONE_PERMISSION }}" == "enabled" ]; then
              echo "    <uses-permission android:name=\"android.permission.RECORD_AUDIO\" />" >> "$PERMISSIONS_FILE"
              echo "✓ Adding MICROPHONE permission"
            fi
            
            if [ "${{ env.NOTIFICATIONS_PERMISSION }}" == "enabled" ]; then
              echo "    <uses-permission android:name=\"android.permission.POST_NOTIFICATIONS\" />" >> "$PERMISSIONS_FILE"
              echo "✓ Adding NOTIFICATIONS permission"
            fi
            
            if [ "${{ env.CONTACTS_PERMISSION }}" == "enabled" ]; then
              echo "    <uses-permission android:name=\"android.permission.READ_CONTACTS\" />" >> "$PERMISSIONS_FILE"
              echo "    <uses-permission android:name=\"android.permission.WRITE_CONTACTS\" />" >> "$PERMISSIONS_FILE"
              echo "✓ Adding CONTACTS permissions"
            fi
            
            # Always add internet permission
            echo "    <uses-permission android:name=\"android.permission.INTERNET\" />" >> "$PERMISSIONS_FILE"
            echo "    <uses-permission android:name=\"android.permission.ACCESS_NETWORK_STATE\" />" >> "$PERMISSIONS_FILE"
            
            # Replace placeholder with file contents
            if [ -s "$PERMISSIONS_FILE" ]; then
              if grep -q "{{PERMISSIONS_PLACEHOLDER}}" "$MANIFEST_PATH"; then
                # Use awk to replace placeholder with file contents
                awk '
                /{{PERMISSIONS_PLACEHOLDER}}/ {
                  while ((getline line < "/tmp/permissions.txt") > 0) {
                    print line
                  }
                  close("/tmp/permissions.txt")
                  next
                }
                {print}
                ' "$MANIFEST_PATH" > "${MANIFEST_PATH}.tmp" && mv "${MANIFEST_PATH}.tmp" "$MANIFEST_PATH"
                echo "✓ Permissions replaced via placeholder"
              else
                echo "✗ Placeholder not found in manifest"
                exit 1
              fi
            else
              # Remove placeholder if no permissions
              sed -i '/{{PERMISSIONS_PLACEHOLDER}}/d' "$MANIFEST_PATH"
              echo "✓ No additional permissions to add"
            fi
            
            # Clean up
            rm -f "$PERMISSIONS_FILE"
            
            echo "Updated AndroidManifest.xml (first 30 lines):"
            head -30 "$MANIFEST_PATH"
          else
            echo "✗ AndroidManifest.xml not found at $MANIFEST_PATH"
            exit 1
          fi

      - name: Setup Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

        
      - name: Install dependencies
        run: |
          echo "Installing dependencies..."
          npm ci --legacy-peer-deps --no-audit --no-fund
          echo "Dependencies installed successfully"

      - name: Intalling JDK
        run: |
          echo "Restructuring Java package..."
          OLD_JAVA_PATH="android/app/src/main/java/com/rn_project_template"
          NEW_JAVA_PATH="android/app/src/main/java/$(echo $NAME_SPACE | tr '.' '/')"
          
          echo "OLD_JAVA_PATH: $OLD_JAVA_PATH"
          echo "NEW_JAVA_PATH: $NEW_JAVA_PATH"
          echo "NAME_SPACE: $NAME_SPACE"
          
          if [ -d "$OLD_JAVA_PATH" ]; then
            echo "Moving from $OLD_JAVA_PATH to $NEW_JAVA_PATH"
            
            # Debug: Show current directory structure
            echo "Current directory structure:"
            find android/app/src/main/java -type d | head -10
            
            # Create the full target directory path
            echo "Creating directory: $NEW_JAVA_PATH"
            mkdir -p "$NEW_JAVA_PATH"
            
            # Verify directory was created
            if [ -d "$NEW_JAVA_PATH" ]; then
              echo "✓ Target directory created successfully"
            else
              echo "✗ Failed to create target directory"
              exit 1
            fi
            
            # List files to be copied
            echo "Files to copy:"
            ls -la "$OLD_JAVA_PATH/"
            
            # Copy files to the new location
            echo "Copying files..."
            cp -r "$OLD_JAVA_PATH"/* "$NEW_JAVA_PATH/"
            
            # Verify copy was successful
            if [ $? -eq 0 ]; then
              echo "✓ Files copied successfully"
              echo "Files in new location:"
              ls -la "$NEW_JAVA_PATH/"
            else
              echo "✗ Copy failed"
              exit 1
            fi
            
            # Remove the old directory
            rm -rf "$OLD_JAVA_PATH"
            
            # Clean up empty com directory if needed
            COM_PATH="android/app/src/main/java/com"
            if [ -d "$COM_PATH" ] && [ -z "$(ls -A $COM_PATH)" ]; then
              rm -rf "$COM_PATH"
            fi
            
            echo "✓ Java package restructured successfully"
            echo "Final directory structure:"
            find android/app/src/main/java -type d | head -10
          else
            echo "✗ Old Java path not found: $OLD_JAVA_PATH"
            echo "Available directories:"
            find android/app/src/main/java -type d 2>/dev/null || echo "No java directory found"
          fi

      - name: Android manifest updating
        run: |
          echo "Adding cleartext traffic permission to AndroidManifest.xml..."
          MANIFEST_PATH="android/app/src/main/AndroidManifest.xml"
          
          if [ -f "$MANIFEST_PATH" ]; then
            # Check if usesCleartextTraffic is already present
            if ! grep -q "android:usesCleartextTraffic" "$MANIFEST_PATH"; then
              # Add the cleartext traffic permission to the application tag
              perl -i -pe 's/(<application[^>]*)/\1\n        android:usesCleartextTraffic="true"/' "$MANIFEST_PATH"
              echo "✓ Added cleartext traffic permission to AndroidManifest.xml"
            else
              echo "✓ Cleartext traffic permission already present"
            fi
          else
            echo "✗ AndroidManifest.xml not found at $MANIFEST_PATH"
          fi

      - name: Installing additional dependency
        if: env.HAS_CUSTOM_ICON == 'true'
        run: |
          echo "Installing Sharp for icon processing..."
          npm install sharp --no-save

      - name: Processing your icon
        if: env.HAS_CUSTOM_ICON == 'true'
        run: |
          echo "Processing custom app icon..."
          node << 'EOF'
          (async () => {
            const sharp = require('sharp');
            const fs = require('fs-extra');
            const path = require('path');
            
            // Get app icon from environment
            const appIcon = process.env.APP_ICON;
            
            if (!appIcon || appIcon === 'null') {
              console.log('No app icon provided, skipping processing');
              process.exit(0);
            }
            
            try {
              let iconBuffer;
              if (appIcon.startsWith('data:image/')) {
                const base64Data = appIcon.replace(/^data:image\/\w+;base64,/, '');
                iconBuffer = Buffer.from(base64Data, 'base64');
              } else {
                iconBuffer = await fs.readFile(appIcon);
              }
              
              const androidResPath = 'android/app/src/main/res';
              
              // Generate drawable icons (matching local build)
              const iconSizes = [
                { size: 36, folder: 'drawable-ldpi' },
                { size: 48, folder: 'drawable-mdpi' },
                { size: 72, folder: 'drawable-hdpi' },
                { size: 96, folder: 'drawable-xhdpi' },
                { size: 144, folder: 'drawable-xxhdpi' },
                { size: 192, folder: 'drawable-xxxhdpi' }
              ];
              
              for (const { size, folder } of iconSizes) {
                const folderPath = path.join(androidResPath, folder);
                await fs.ensureDir(folderPath);
                
                await sharp(iconBuffer)
                  .resize(size, size)
                  .png()
                  .toFile(path.join(folderPath, 'ic_launcher.png'));
                  
                console.log(`Generated ${folder}/ic_launcher.png`);
              }
              
              // Generate mipmap icons (matching local build)
              const roundIconSizes = [
                { size: 48, folder: 'mipmap-mdpi' },
                { size: 72, folder: 'mipmap-hdpi' },
                { size: 96, folder: 'mipmap-xhdpi' },
                { size: 144, folder: 'mipmap-xxhdpi' },
                { size: 192, folder: 'mipmap-xxxhdpi' }
              ];
              
              for (const { size, folder } of roundIconSizes) {
                const folderPath = path.join(androidResPath, folder);
                await fs.ensureDir(folderPath);
                
                await sharp(iconBuffer)
                  .resize(size, size)
                  .png()
                  .toFile(path.join(folderPath, 'ic_launcher.png'));
                  
                await sharp(iconBuffer)
                  .resize(size, size)
                  .png()
                  .toFile(path.join(folderPath, 'ic_launcher_round.png'));
                  
                console.log(`Generated ${folder}/ic_launcher.png and ic_launcher_round.png`);
              }
              
              console.log('All app icons generated successfully');
              
            } catch (error) {
              console.error('Error processing app icon:', error);
              process.exit(1);
            }
          })();
          EOF

      - name: Make gradlew executable
        run: chmod +x android/gradlew

      - name: Validate Android environment
        run: |
          echo "Validating Android build environment..."
          
          # Check required files
          required_files=(
            "android/gradlew"
            "android/app/build.gradle"
            "android/build.gradle"
          )
          
          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "✗ Required file not found: $file"
              exit 1
            else
              echo "✓ Found: $file"
            fi
          done
          
          echo "Android environment validation completed"
          

      - name: Building Android App 
        run: |
          cd android
          echo "Building Android app..."
          echo "Build Type: ${{ env.BUILD_TYPE }}"
          echo "Output Type: ${{ env.OUTPUT_TYPE }}"
          
          # Set environment variables matching local build
          export GRADLE_OPTS="-Xmx2g -Dorg.gradle.daemon=false"
          
          # Determine build arguments based on type and output
          if [ "${{ env.BUILD_TYPE }}" == "release" ]; then
            if [ "${{ env.OUTPUT_TYPE }}" == "aab" ]; then
              echo "Building release AAB..."
              ./gradlew bundleRelease --stacktrace --info --no-daemon
            else
              echo "Building release APK..."
              ./gradlew assembleRelease --stacktrace --info --no-daemon
            fi
          else
            echo "Building debug APK..."
            ./gradlew assembleDebug --stacktrace --info --no-daemon
          fi

      - name: Verify and copy build outputs
        id: verify_outputs
        run: |
          echo "Verifying build outputs..."
          
          # Determine expected build path based on build type and output type
          if [ "${{ env.OUTPUT_TYPE }}" == "aab" ]; then
            BUILT_APP_PATH="android/app/build/outputs/bundle/release/app-release.aab"
          else
            if [ "${{ env.BUILD_TYPE }}" == "release" ]; then
              BUILT_APP_PATH="android/app/build/outputs/apk/release/app-release.apk"
            else
              BUILT_APP_PATH="android/app/build/outputs/apk/debug/app-debug.apk"
            fi
          fi
          
          echo "Looking for built app at: $BUILT_APP_PATH"
          
          if [ -f "$BUILT_APP_PATH" ]; then
            echo "✓ Built app found at: $BUILT_APP_PATH"
            
            # Create artifacts directory
            mkdir -p artifacts
            
            # Generate output filename
            BUILD_ID="${{ env.BUILD_ID }}"
            APP_NAME="${{ env.APP_NAME }}"
            BUILD_TYPE="${{ env.BUILD_TYPE }}"
            OUTPUT_TYPE="${{ env.OUTPUT_TYPE }}"
            
            # Clean app name for filename
            CLEAN_APP_NAME=$(echo "$APP_NAME" | sed 's/[^a-zA-Z0-9]/_/g')
            ARTIFACT_NAME="${CLEAN_APP_NAME}-${BUILD_TYPE}-${BUILD_ID}.${OUTPUT_TYPE}"
            
            # Copy built app to artifacts
            cp "$BUILT_APP_PATH" "artifacts/$ARTIFACT_NAME"
            echo "✓ Copied built app to artifacts/$ARTIFACT_NAME"
            
            # Get file size
            FILE_SIZE=$(stat -c%s "artifacts/$ARTIFACT_NAME")
            echo "FILE_SIZE=$FILE_SIZE" >> $GITHUB_ENV
            echo "ARTIFACT_NAME=$ARTIFACT_NAME" >> $GITHUB_ENV
            
            echo "Build completed successfully!"
            echo "File: $ARTIFACT_NAME"
            echo "Size: $FILE_SIZE bytes"
          else
            echo "✗ Built app not found at expected path: $BUILT_APP_PATH"
            echo "Available files in build outputs:"
            find android/app/build/outputs -name "*.apk" -o -name "*.aab" -type f | head -20
            exit 1
          fi

      - name: Create build info
        run: |
          BUILD_ID="${{ env.BUILD_ID }}"
          TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          
          cat > artifacts/build-info.json << EOF
          {
            "buildId": "$BUILD_ID",
            "appName": "${{ env.APP_NAME }}", 
            "buildType": "${{ env.BUILD_TYPE }}",
            "outputType": "${{ env.OUTPUT_TYPE }}",
            "platform": "android",
            "timestamp": "$TIMESTAMP",
            "versionCode": "${{ env.VERSION_CODE }}",
            "versionName": "${{ env.VERSION_NAME }}",
            "namespace": "${{ env.NAME_SPACE }}",
            "websiteAddress": "${{ env.WEBSITE_ADDRESS }}",
            "fileSize": ${{ env.FILE_SIZE }},
            "fileName": "${{ env.ARTIFACT_NAME }}",
            "hasCustomIcon": ${{ env.HAS_CUSTOM_ICON }}
          }
          EOF
          
          echo "Build info created successfully"

      - name: Configure storage server 
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION || 'us-east-1' }}

      - name: Uploading your app to server
        id: upload_s3
        run: |
          echo "Uploading artifacts to AWS S3..."
          BUILD_ID="${{ env.BUILD_ID }}"
          S3_BUCKET="${{ secrets.AWS_S3_BUCKET }}"
          S3_PREFIX="builds/${BUILD_ID}"
          ARTIFACT_NAME="${{ env.ARTIFACT_NAME }}"
          
          if [ -z "$S3_BUCKET" ]; then
            echo "Error: AWS_S3_BUCKET secret not configured"
            exit 1
          fi
          
          # Upload the app file
          echo "Uploading $ARTIFACT_NAME to S3..."
          aws s3 cp "artifacts/$ARTIFACT_NAME" "s3://${S3_BUCKET}/${S3_PREFIX}/" --no-progress
          
          # Upload build info
          echo "Uploading build-info.json to S3..."
          aws s3 cp artifacts/build-info.json "s3://${S3_BUCKET}/${S3_PREFIX}/" --no-progress
          
          # Generate presigned URLs (valid for 7 days)
          APP_DOWNLOAD_URL=$(aws s3 presign "s3://${S3_BUCKET}/${S3_PREFIX}/${ARTIFACT_NAME}" --expires-in 604800)
          INFO_DOWNLOAD_URL=$(aws s3 presign "s3://${S3_BUCKET}/${S3_PREFIX}/build-info.json" --expires-in 604800)
          
          echo "APP_DOWNLOAD_URL=$APP_DOWNLOAD_URL" >> $GITHUB_ENV
          echo "INFO_DOWNLOAD_URL=$INFO_DOWNLOAD_URL" >> $GITHUB_ENV
          
          echo "✓ Upload completed successfully"
          echo "✓ App download URL: $APP_DOWNLOAD_URL"

      - name: Update build status
        if: always()
        run: |
          BUILD_ID="${{ env.BUILD_ID }}"
          S3_BUCKET="${{ secrets.AWS_S3_BUCKET }}"
          
          if [ "${{ job.status }}" == "success" ]; then
            STATUS="completed"
            CONCLUSION="success"
            MESSAGE="Build completed successfully"
            DOWNLOAD_URL="${APP_DOWNLOAD_URL:-null}"
            INFO_URL="${INFO_DOWNLOAD_URL:-null}"
          else
            STATUS="completed"
            CONCLUSION="failure"
            MESSAGE="Build failed - check logs for details"
            DOWNLOAD_URL="null"
            INFO_URL="null"
          fi
          
          cat > build-status.json << EOF
          {
            "buildId": "$BUILD_ID",
            "status": "$STATUS",
            "conclusion": "$CONCLUSION",
            "message": "$MESSAGE",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "downloadUrl": $DOWNLOAD_URL,
            "infoUrl": $INFO_URL,
            "repository": "${{ github.repository }}",
            "runId": "${{ github.run_id }}",
            "appName": "${{ env.APP_NAME }}",
            "buildType": "${{ env.BUILD_TYPE }}",
            "outputType": "${{ env.OUTPUT_TYPE }}",
            "fileSize": ${{ env.FILE_SIZE || 0 }}
          }
          EOF
          
          # Upload status to S3
          if [ -n "$S3_BUCKET" ]; then
            aws s3 cp build-status.json "s3://${S3_BUCKET}/status/${BUILD_ID}.json" --no-progress
            echo "✓ Build status updated: $STATUS - $CONCLUSION"
          fi

      - name: Notify completion
        if: always()
        run: |
          echo "=================================="
          echo "BUILD PROCESS COMPLETED"
          echo "=================================="
          echo "Status: ${{ job.status }}"
          echo "Build ID: ${{ env.BUILD_ID }}"
          echo "App Name: ${{ env.APP_NAME }}"
          echo "Build Type: ${{ env.BUILD_TYPE }}"
          echo "Output Type: ${{ env.OUTPUT_TYPE }}"
          echo "Namespace: ${{ env.NAME_SPACE }}"
          echo "Version: ${{ env.VERSION_NAME }} (${{ env.VERSION_CODE }})"
          
          if [ "${{ job.status }}" == "success" ]; then
            echo "File Size: ${{ env.FILE_SIZE }} bytes"
            echo "Download URL: ${{ env.APP_DOWNLOAD_URL }}"
          fi
          echo "=================================="

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: android-build-${{ env.BUILD_ID }}
          path: artifacts/
          retention-days: 7
