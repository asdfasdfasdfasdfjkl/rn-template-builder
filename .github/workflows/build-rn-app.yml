name: Fast React Native Android Build

on:
  workflow_dispatch:
    inputs:
      build_id:
        description: 'Build ID'
        required: true
        type: string
      app_name:
        description: 'App Name'
        required: true
        type: string
      build_type:
        description: 'Build Type'
        required: false
        default: 'release'
        type: choice
        options:
          - release
          - debug
      output_type:
        description: 'Output Type'
        required: false
        default: 'apk'
        type: choice
        options:
          - apk
          - aab

env:
  BUILD_ID: ${{ github.event.inputs.build_id }}
  APP_NAME: ${{ github.event.inputs.app_name }}
  BUILD_TYPE: ${{ github.event.inputs.build_type || 'release' }}
  OUTPUT_TYPE: ${{ github.event.inputs.output_type || 'apk' }}
  NODE_VERSION: '18'
  JAVA_VERSION: '17'

jobs:
  fast-build:
    runs-on: ubuntu-latest
    timeout-minutes: 8

    steps:
      - name: "ðŸ“¥ Checkout Repository"
        uses: actions/checkout@v4

      - name: "âš™ï¸ Setup Node.js with Cache"
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'

      - name: "ðŸ“¦ Install Dependencies"
        run: npm ci --legacy-peer-deps --no-audit --no-fund --prefer-offline

      - name: "â˜• Setup Java with Gradle Cache"
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'gradle'

      - name: "ðŸ¤– Setup Android SDK"
        uses: android-actions/setup-android@v3

      - name: "ðŸ“¦ Restore Android SDK Cache"
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.ANDROID_HOME }}/licenses
            ${{ env.ANDROID_HOME }}/ndk
            ${{ env.ANDROID_HOME }}/platforms
            ${{ env.ANDROID_HOME }}/platform-tools
            ${{ env.ANDROID_HOME }}/build-tools
          key: android-sdk-${{ runner.os }}-${{ hashFiles('android/**/build.gradle*') }}
          restore-keys: |
            android-sdk-${{ runner.os }}-

      - name: "ðŸ“¦ Restore Gradle Cache"
        uses: actions/cache@v4
        id: gradle-cache
        with:
          path: |
            ~/.gradle/wrapper
            ~/.gradle/caches
            ~/.gradle/daemon
            android/.gradle
            android/app/build
          key: gradle-${{ runner.os }}-${{ hashFiles('android/gradle/wrapper/gradle-wrapper.properties', 'android/**/build.gradle*') }}
          restore-keys: |
            gradle-${{ runner.os }}-

      - name: "ðŸ“‹ Read Build Configuration"
        id: config
        run: |
          echo "Loading build configuration..."
          CONFIG=$(cat build-config.json)
          WEBSITE_ADDRESS=$(echo $CONFIG | jq -r '.website_address')
          VERSION_CODE=$(echo $CONFIG | jq -r '.version_code')
          VERSION_NAME=$(echo $CONFIG | jq -r '.version_name')
          NAME_SPACE=$(echo $CONFIG | jq -r '.name_space')
          
          {
            echo "WEBSITE_ADDRESS=$WEBSITE_ADDRESS"
            echo "VERSION_CODE=$VERSION_CODE"
            echo "VERSION_NAME=$VERSION_NAME"
            echo "NAME_SPACE=$NAME_SPACE"
          } >> $GITHUB_ENV

      - name: "ðŸ”§ Smart Template Customization"
        run: |
          echo "Applying optimized template customizations..."
          
          # Use faster single-pass replacement
          {
            # Critical: Only replace in files that don't affect Gradle cache keys
            sed -i "s|{{website_address}}|$WEBSITE_ADDRESS|g" App.tsx
            sed -i "s/{{app_name}}/$APP_NAME/g" app.json
            sed -i "s/rn_project_template/$(echo $APP_NAME | sed 's/[^a-zA-Z0-9]//g')/g" app.json
            
            # AndroidManifest.xml - permissions
            sed -i 's/{{PERMISSIONS_PLACEHOLDER}}/<uses-permission android:name="android.permission.INTERNET" \/>\n    <uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" \/>/g' android/app/src/main/AndroidManifest.xml
            
            # Strings.xml - app name
            sed -i "s/rn_project_template/$APP_NAME/g" android/app/src/main/res/values/strings.xml
          }

      - name: "ðŸ“¦ Dynamic Gradle Configuration"
        run: |
          echo "Applying dynamic configuration without breaking cache..."
          
          # Create a dynamic gradle properties file
          cat > android/dynamic.gradle << 'GRADLE_SCRIPT'
          ext {
              dynamicVersionCode = ${{ env.VERSION_CODE }}
              dynamicVersionName = "${{ env.VERSION_NAME }}"
              dynamicApplicationId = "${{ env.NAME_SPACE }}"
          }
          
          android {
              defaultConfig {
                  versionCode dynamicVersionCode
                  versionName dynamicVersionName
                  applicationId dynamicApplicationId
              }
          }
          GRADLE_SCRIPT
          
          # Apply the dynamic configuration
          echo "apply from: 'dynamic.gradle'" >> android/app/build.gradle

      - name: "ðŸ”§ Make Gradlew Executable"
        run: chmod +x android/gradlew

      - name: "âš¡ Fast Android Build"
        run: |
          cd android
          echo "Starting fast incremental build..."
          
          export GRADLE_OPTS="-Xmx3g -Dorg.gradle.daemon=false -Dorg.gradle.parallel=true -Dorg.gradle.caching=true -Dorg.gradle.configureondemand=true"
          
          if [ "${{ env.BUILD_TYPE }}" == "release" ]; then
            if [ "${{ env.OUTPUT_TYPE }}" == "aab" ]; then
              ./gradlew bundleRelease \
                --build-cache \
                --parallel \
                --max-workers=4 \
                --no-daemon \
                --configure-on-demand \
                -Dorg.gradle.jvmargs="-Xmx2g -XX:MaxMetaspaceSize=256m"
            else
              ./gradlew assembleRelease \
                --build-cache \
                --parallel \
                --max-workers=4 \
                --no-daemon \
                --configure-on-demand \
                -Dorg.gradle.jvmargs="-Xmx2g -XX:MaxMetaspaceSize=256m"
            fi
          else
            ./gradlew assembleDebug \
              --build-cache \
              --parallel \
              --max-workers=4 \
              --no-daemon \
              --configure-on-demand \
              -Dorg.gradle.jvmargs="-Xmx2g -XX:MaxMetaspaceSize=256m"
          fi

      - name: "âœ… Verify Build Output"
        run: |
          if [ "${{ env.OUTPUT_TYPE }}" == "aab" ]; then
            OUTPUT_PATH="android/app/build/outputs/bundle/release/app-release.aab"
          else
            OUTPUT_PATH="android/app/build/outputs/apk/release/app-release.apk"
          fi
          
          if [ -f "$OUTPUT_PATH" ]; then
            echo "âœ… Build successful!"
            echo "Output: $OUTPUT_PATH"
            ls -la "$OUTPUT_PATH"
          else
            echo "âŒ Build failed - output not found"
            exit 1
          fi

      - name: "ðŸ“Š Build Performance Report"
        if: always()
        run: |
          echo "## âš¡ Build Performance Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Cache Status**: ${{ steps.gradle-cache.outputs.cache-hit == 'true' && 'âœ… HIT' || 'âš ï¸ MISS' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Time**: ~1-2 minutes (optimized)" >> $GITHUB_STEP_SUMMARY
          echo "- **Strategy**: Incremental build with preserved cache" >> $GITHUB_STEP_SUMMARY
