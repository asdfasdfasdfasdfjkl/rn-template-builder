name: Build React Native Android App

on:
  workflow_dispatch:
    inputs:
      build_id:
        description: 'Build ID'
        required: true
        type: string
      app_name:
        description: 'App Name'
        required: true
        type: string
      build_type:
        description: 'Build Type'
        required: false
        default: 'release'
        type: choice
        options:
          - release
          - debug
      output_type:
        description: 'Output Type'
        required: false
        default: 'apk'
        type: choice
        options:
          - apk
          - aab
      platform:
        description: 'Platform'
        required: false
        default: 'android'
        type: string

env:
  BUILD_ID: ${{ github.event.inputs.build_id }}
  APP_NAME: ${{ github.event.inputs.app_name }}
  BUILD_TYPE: ${{ github.event.inputs.build_type || 'release' }}
  OUTPUT_TYPE: ${{ github.event.inputs.output_type || 'apk' }}
  PLATFORM: ${{ github.event.inputs.platform || 'android' }}
  NODE_VERSION: '18'
  JAVA_VERSION: '17'
  ANDROID_HOME: /opt/android-sdk-linux
  ANDROID_SDK_ROOT: /opt/android-sdk-linux

jobs:
  build-android:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: "üì• Checkout Repository"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "üìã Read Build Configuration"
        id: config
        run: |
          echo "Loading build configuration..."
          if [ -f "build-config.json" ]; then
            CONFIG=$(cat build-config.json)
            WEBSITE_ADDRESS=$(echo $CONFIG | jq -r '.website_address // "https://example.com"')
            VERSION_CODE=$(echo $CONFIG | jq -r '.version_code // "1"')
            VERSION_NAME=$(echo $CONFIG | jq -r '.version_name // "1.0.0"')
            NAME_SPACE=$(echo $CONFIG | jq -r '.name_space // "com.example.app"')
            APP_ICON=$(echo $CONFIG | jq -r '.app_icon // "null"')
            HAS_CUSTOM_ICON=$(echo $CONFIG | jq -r '.has_custom_icon // "false"')
            
            # Extract permissions with defaults
            CAMERA_PERMISSION=$(echo $CONFIG | jq -r '.permissions.camera // "disabled"')
            LOCATION_PERMISSION=$(echo $CONFIG | jq -r '.permissions.location // "disabled"')
            MICROPHONE_PERMISSION=$(echo $CONFIG | jq -r '.permissions.microphone // "disabled"')
            NOTIFICATIONS_PERMISSION=$(echo $CONFIG | jq -r '.permissions.notifications // "disabled"')
            CONTACTS_PERMISSION=$(echo $CONFIG | jq -r '.permissions.contacts // "disabled"')
            
            # Set environment variables
            {
              echo "WEBSITE_ADDRESS=$WEBSITE_ADDRESS"
              echo "VERSION_CODE=$VERSION_CODE"
              echo "VERSION_NAME=$VERSION_NAME"
              echo "NAME_SPACE=$NAME_SPACE"
              echo "APP_ICON=$APP_ICON"
              echo "HAS_CUSTOM_ICON=$HAS_CUSTOM_ICON"
              echo "CAMERA_PERMISSION=$CAMERA_PERMISSION"
              echo "LOCATION_PERMISSION=$LOCATION_PERMISSION"
              echo "MICROPHONE_PERMISSION=$MICROPHONE_PERMISSION"
              echo "NOTIFICATIONS_PERMISSION=$NOTIFICATIONS_PERMISSION"
              echo "CONTACTS_PERMISSION=$CONTACTS_PERMISSION"
            } >> $GITHUB_ENV
          else
            echo "Error: build-config.json not found!"
            exit 1
          fi

      - name: "‚öôÔ∏è Setup Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: "üì¶ Restore NPM Cache"
        uses: actions/cache/restore@v4
        id: npm-cache
        with:
          path: |
            ~/.npm
            node_modules
          key: ${{ runner.os }}-npm-${{ env.NODE_VERSION }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-${{ env.NODE_VERSION }}-
            ${{ runner.os }}-npm-

      - name: "üì¶ Install Dependencies (if needed)"
        if: steps.npm-cache.outputs.cache-hit != 'true'
        run: npm ci --legacy-peer-deps --no-audit --no-fund

      - name: "‚òï Setup Java JDK"
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: "üì¶ Restore Android SDK Cache"
        uses: actions/cache/restore@v4
        id: android-sdk-cache
        with:
          path: |
            ${{ env.ANDROID_HOME }}
            ~/.android
          key: ${{ runner.os }}-android-sdk-${{ env.JAVA_VERSION }}-${{ hashFiles('android/build.gradle', 'android/app/build.gradle') }}
          restore-keys: |
            ${{ runner.os }}-android-sdk-${{ env.JAVA_VERSION }}-
            ${{ runner.os }}-android-sdk-

      - name: "ü§ñ Setup Android SDK (if needed)"
        if: steps.android-sdk-cache.outputs.cache-hit != 'true'
        uses: android-actions/setup-android@v3

      - name: "üì¶ Restore Gradle Wrapper Cache"
        uses: actions/cache/restore@v4
        with:
          path: ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-wrapper-${{ hashFiles('android/gradle/wrapper/gradle-wrapper.properties') }}

      - name: "üì¶ Restore Gradle Dependencies Cache"
        uses: actions/cache/restore@v4
        id: gradle-cache
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/daemon
            android/.gradle
          key: ${{ runner.os }}-gradle-deps-${{ env.JAVA_VERSION }}-${{ hashFiles('android/build.gradle', 'android/app/build.gradle', 'android/gradle/wrapper/gradle-wrapper.properties') }}

      - name: "üì¶ Restore Kotlin Cache"
        uses: actions/cache/restore@v4
        with:
          path: |
            ~/.konan
            ~/.kotlin
          key: ${{ runner.os }}-kotlin-${{ hashFiles('android/build.gradle', 'android/app/build.gradle') }}

      - name: "üì¶ Restore Native Dependencies Cache"
        uses: actions/cache/restore@v4
        id: native-deps-cache
        with:
          path: |
            node_modules/sharp
            node_modules/@img
          key: ${{ runner.os }}-native-deps-${{ hashFiles('**/package-lock.json') }}

      - name: "üñºÔ∏è Install Sharp (if needed)"
        if: env.HAS_CUSTOM_ICON == 'true' && steps.native-deps-cache.outputs.cache-hit != 'true'
        run: npm install sharp --no-save

      # NEW: Restore pre-built Android outputs
      - name: "üì¶ Restore Android Build Cache"
        uses: actions/cache/restore@v4
        id: android-build-cache
        with:
          path: |
            android/app/build/intermediates
            android/app/build/tmp
            android/app/.cxx
            android/.gradle/buildOutputCleanup
          key: ${{ runner.os }}-android-build-${{ hashFiles('android/build.gradle', 'android/app/build.gradle', 'android/app/src/**/*.kt', 'android/app/src/**/*.java') }}
          restore-keys: |
            ${{ runner.os }}-android-build-

      - name: "üì¶ Restore Compiled Classes Cache"
        uses: actions/cache/restore@v4
        with:
          path: |
            android/app/build/tmp/kotlin-classes
            android/app/build/intermediates/compile_app_classes_jar
            android/app/build/intermediates/compile_library_classes_jar
          key: ${{ runner.os }}-compiled-classes-${{ hashFiles('android/app/src/**/*.kt', 'android/app/src/**/*.java') }}

      - name: "üì¶ Restore Dex Cache"
        uses: actions/cache/restore@v4
        with:
          path: |
            android/app/build/intermediates/dex
            android/app/build/intermediates/external_libs_dex
          key: ${{ runner.os }}-dex-${{ hashFiles('android/app/build.gradle', '**/package-lock.json') }}

      - name: "üîß Apply Template Customizations"
        shell: bash
        run: |
          echo "Applying template customizations..."
          
          NAME_SPACE_PARTS=(${NAME_SPACE//./ })
          if [ ${#NAME_SPACE_PARTS[@]} -ge 3 ]; then
            MIDDLE_SEGMENT=${NAME_SPACE_PARTS[1]}
          else
            MIDDLE_SEGMENT=${NAME_SPACE_PARTS[-1]}
          fi
          
          # Use faster sed replacements instead of perl
          find android -type f \( -name "*.gradle" -o -name "*.kt" -o -name "*.xml" \) -exec sed -i "s/rn_project_template/$MIDDLE_SEGMENT/g" {} +
          sed -i "s/rn_project_template/$MIDDLE_SEGMENT/g" app.json
          sed -i "s/{{name_space}}/$NAME_SPACE/g" android/app/src/main/java/com/rn_project_template/MainActivity.kt
          sed -i "s|{{website_address}}|$WEBSITE_ADDRESS|g" App.tsx
          sed -i "s/{{app_name}}/$APP_NAME/g" app.json
          sed -i "s/{{version_code}}/$VERSION_CODE/g" android/app/build.gradle
          sed -i "s/{{version_name}}/$VERSION_NAME/g" android/app/build.gradle
          sed -i "s/com.rn_project_template/$NAME_SPACE/g" android/app/build.gradle
          sed -i "s/com.rn_project_template/$NAME_SPACE/g" android/app/src/main/java/com/rn_project_template/MainActivity.kt
          sed -i "s/com.rn_project_template/$NAME_SPACE/g" android/app/src/main/java/com/rn_project_template/MainApplication.kt
          sed -i "s/{{name_space}}/$NAME_SPACE/g" android/app/src/main/AndroidManifest.xml
          sed -i "s/rn_project_template/$APP_NAME/g" android/app/src/main/res/values/strings.xml

      - name: "üîê Generate Permission Configuration"
        run: |
          cat > permissionConfig.js << EOF
          export const PERMISSION_CONFIG = {
            camera: ${{ env.CAMERA_PERMISSION == 'enabled' && 'true' || 'false' }},
            location: ${{ env.LOCATION_PERMISSION == 'enabled' && 'true' || 'false' }},
            microphone: ${{ env.MICROPHONE_PERMISSION == 'enabled' && 'true' || 'false' }},
            notifications: ${{ env.NOTIFICATIONS_PERMISSION == 'enabled' && 'true' || 'false' }},
            contacts: ${{ env.CONTACTS_PERMISSION == 'enabled' && 'true' || 'false' }}
          };
          EOF

      - name: "üìù Update Android Manifest with Permissions"
        run: |
          MANIFEST_PATH="android/app/src/main/AndroidManifest.xml"
          PERMISSIONS=""
          
          [ "${{ env.CAMERA_PERMISSION }}" == "enabled" ] && PERMISSIONS="${PERMISSIONS}    <uses-permission android:name=\"android.permission.CAMERA\" />\n"
          [ "${{ env.LOCATION_PERMISSION }}" == "enabled" ] && PERMISSIONS="${PERMISSIONS}    <uses-permission android:name=\"android.permission.ACCESS_FINE_LOCATION\" />\n    <uses-permission android:name=\"android.permission.ACCESS_COARSE_LOCATION\" />\n"
          [ "${{ env.MICROPHONE_PERMISSION }}" == "enabled" ] && PERMISSIONS="${PERMISSIONS}    <uses-permission android:name=\"android.permission.RECORD_AUDIO\" />\n"
          [ "${{ env.NOTIFICATIONS_PERMISSION }}" == "enabled" ] && PERMISSIONS="${PERMISSIONS}    <uses-permission android:name=\"android.permission.POST_NOTIFICATIONS\" />\n"
          [ "${{ env.CONTACTS_PERMISSION }}" == "enabled" ] && PERMISSIONS="${PERMISSIONS}    <uses-permission android:name=\"android.permission.READ_CONTACTS\" />\n    <uses-permission android:name=\"android.permission.WRITE_CONTACTS\" />\n"
          
          PERMISSIONS="${PERMISSIONS}    <uses-permission android:name=\"android.permission.INTERNET\" />\n    <uses-permission android:name=\"android.permission.ACCESS_NETWORK_STATE\" />"
          
          sed -i "s/{{PERMISSIONS_PLACEHOLDER}}/$PERMISSIONS/g" "$MANIFEST_PATH"

      - name: "üñºÔ∏è Process Custom App Icon"
        if: env.HAS_CUSTOM_ICON == 'true'
        run: |
          node << 'EOF'
          (async () => {
            const sharp = require('sharp');
            const fs = require('fs-extra');
            const path = require('path');
            
            const appIcon = process.env.APP_ICON;
            if (!appIcon || appIcon === 'null') {
              console.log('No app icon provided, skipping processing');
              process.exit(0);
            }
            
            try {
              let iconBuffer;
              if (appIcon.startsWith('data:image/')) {
                const base64Data = appIcon.replace(/^data:image\/\w+;base64,/, '');
                iconBuffer = Buffer.from(base64Data, 'base64');
              } else {
                iconBuffer = await fs.readFile(appIcon);
              }
              
              const androidResPath = 'android/app/src/main/res';
              
              const iconSizes = [
                { size: 36, folder: 'drawable-ldpi' },
                { size: 48, folder: 'drawable-mdpi' },
                { size: 72, folder: 'drawable-hdpi' },
                { size: 96, folder: 'drawable-xhdpi' },
                { size: 144, folder: 'drawable-xxhdpi' },
                { size: 192, folder: 'drawable-xxxhdpi' }
              ];
              
              // Process all icons in parallel for speed
              const iconPromises = [];
              
              for (const { size, folder } of iconSizes) {
                const folderPath = path.join(androidResPath, folder);
                await fs.ensureDir(folderPath);
                iconPromises.push(
                  sharp(iconBuffer).resize(size, size).png().toFile(path.join(folderPath, 'ic_launcher.png'))
                );
              }
              
              const roundIconSizes = [
                { size: 48, folder: 'mipmap-mdpi' },
                { size: 72, folder: 'mipmap-hdpi' },
                { size: 96, folder: 'mipmap-xhdpi' },
                { size: 144, folder: 'mipmap-xxhdpi' },
                { size: 192, folder: 'mipmap-xxxhdpi' }
              ];
              
              for (const { size, folder } of roundIconSizes) {
                const folderPath = path.join(androidResPath, folder);
                await fs.ensureDir(folderPath);
                iconPromises.push(
                  sharp(iconBuffer).resize(size, size).png().toFile(path.join(folderPath, 'ic_launcher.png'))
                );
                iconPromises.push(
                  sharp(iconBuffer).resize(size, size).png().toFile(path.join(folderPath, 'ic_launcher_round.png'))
                );
              }
              
              await Promise.all(iconPromises);
              console.log('All app icons generated successfully');
            } catch (error) {
              console.error('Error processing app icon:', error);
              process.exit(1);
            }
          })();
          EOF

      - name: "üìÅ Restructure Java Package"
        run: |
          OLD_JAVA_PATH="android/app/src/main/java/com/rn_project_template"
          NEW_JAVA_PATH="android/app/src/main/java/$(echo $NAME_SPACE | tr '.' '/')"
          
          if [ -d "$OLD_JAVA_PATH" ]; then
            mkdir -p "$NEW_JAVA_PATH"
            cp -r "$OLD_JAVA_PATH"/* "$NEW_JAVA_PATH/"
            rm -rf "$OLD_JAVA_PATH"
            
            # Clean up empty com directory if needed
            COM_PATH="android/app/src/main/java/com"
            if [ -d "$COM_PATH" ] && [ -z "$(ls -A $COM_PATH)" ]; then
              rm -rf "$COM_PATH"
            fi
          fi

      - name: "üåê Enable Cleartext Traffic"
        run: |
          MANIFEST_PATH="android/app/src/main/AndroidManifest.xml"
          if [ -f "$MANIFEST_PATH" ] && ! grep -q "android:usesCleartextTraffic" "$MANIFEST_PATH"; then
            sed -i 's/<application/<application\n        android:usesCleartextTraffic="true"/g' "$MANIFEST_PATH"
          fi

      - name: "üîß Make Gradlew Executable"
        run: chmod +x android/gradlew

      - name: "üèóÔ∏è Build Android App (Incremental)"
        run: |
          cd android
          echo "Building Android app with cached dependencies and pre-built outputs..."
          
          # Optimized for speed with aggressive caching
          export GRADLE_OPTS="-Xmx4g -XX:MaxMetaspaceSize=512m -Dorg.gradle.daemon=false -Dorg.gradle.parallel=true -Dorg.gradle.caching=true -Dorg.gradle.configureondemand=true"
          export _JAVA_OPTIONS="-Xmx3g"
          
          # Use incremental compilation
          if [ "${{ env.BUILD_TYPE }}" == "release" ]; then
            if [ "${{ env.OUTPUT_TYPE }}" == "aab" ]; then
              ./gradlew bundleRelease \
                --build-cache \
                --parallel \
                --max-workers=4 \
                --no-daemon \
                -Dorg.gradle.jvmargs="-Xmx3g" \
                -Pkotlin.incremental=true \
                -Pkotlin.incremental.usePreciseJavaTracking=true
            else
              ./gradlew assembleRelease \
                --build-cache \
                --parallel \
                --max-workers=4 \
                --no-daemon \
                -Dorg.gradle.jvmargs="-Xmx3g" \
                -Pkotlin.incremental=true \
                -Pkotlin.incremental.usePreciseJavaTracking=true
            fi
          else
            ./gradlew assembleDebug \
              --build-cache \
              --parallel \
              --max-workers=4 \
              --no-daemon \
              -Dorg.gradle.jvmargs="-Xmx3g" \
              -Pkotlin.incremental=true \
              -Pkotlin.incremental.usePreciseJavaTracking=true
          fi

      - name: "‚úÖ Verify Build Output"
        id: verify_outputs
        run: |
          if [ "${{ env.OUTPUT_TYPE }}" == "aab" ]; then
            BUILT_APP_PATH="android/app/build/outputs/bundle/release/app-release.aab"
          else
            if [ "${{ env.BUILD_TYPE }}" == "release" ]; then
              BUILT_APP_PATH="android/app/build/outputs/apk/release/app-release.apk"
            else
              BUILT_APP_PATH="android/app/build/outputs/apk/debug/app-debug.apk"
            fi
          fi
          
          if [ -f "$BUILT_APP_PATH" ]; then
            mkdir -p artifacts
            BUILD_ID="${{ env.BUILD_ID }}"
            APP_NAME="${{ env.APP_NAME }}"
            BUILD_TYPE="${{ env.BUILD_TYPE }}"
            OUTPUT_TYPE="${{ env.OUTPUT_TYPE }}"
            CLEAN_APP_NAME=$(echo "$APP_NAME" | sed 's/[^a-zA-Z0-9]/_/g')
            ARTIFACT_NAME="${CLEAN_APP_NAME}-${BUILD_TYPE}-${BUILD_ID}.${OUTPUT_TYPE}"
            
            cp "$BUILT_APP_PATH" "artifacts/$ARTIFACT_NAME"
            FILE_SIZE=$(stat -c%s "artifacts/$ARTIFACT_NAME")
            echo "FILE_SIZE=$FILE_SIZE" >> $GITHUB_ENV
            echo "ARTIFACT_NAME=$ARTIFACT_NAME" >> $GITHUB_ENV
            
            echo "‚úÖ Build successful! Output: $ARTIFACT_NAME ($(du -h artifacts/$ARTIFACT_NAME | cut -f1))"
          else
            echo "‚ùå Build failed - output not found at: $BUILT_APP_PATH"
            exit 1
          fi

      - name: "üìä Create Build Information"
        run: |
          BUILD_ID="${{ env.BUILD_ID }}"
          TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          
          cat > artifacts/build-info.json << EOF
          {
            "buildId": "$BUILD_ID",
            "appName": "${{ env.APP_NAME }}", 
            "buildType": "${{ env.BUILD_TYPE }}",
            "outputType": "${{ env.OUTPUT_TYPE }}",
            "platform": "android",
            "timestamp": "$TIMESTAMP",
            "versionCode": "${{ env.VERSION_CODE }}",
            "versionName": "${{ env.VERSION_NAME }}",
            "namespace": "${{ env.NAME_SPACE }}",
            "websiteAddress": "${{ env.WEBSITE_ADDRESS }}",
            "fileSize": ${{ env.FILE_SIZE }},
            "fileName": "${{ env.ARTIFACT_NAME }}",
            "hasCustomIcon": ${{ env.HAS_CUSTOM_ICON }},
            "cacheStatus": {
              "npm": "${{ steps.npm-cache.outputs.cache-hit == 'true' && 'HIT' || 'MISS' }}",
              "gradle": "${{ steps.gradle-cache.outputs.cache-hit == 'true' && 'HIT' || 'MISS' }}",
              "androidSdk": "${{ steps.android-sdk-cache.outputs.cache-hit == 'true' && 'HIT' || 'MISS' }}",
              "androidBuild": "${{ steps.android-build-cache.outputs.cache-hit == 'true' && 'HIT' || 'MISS' }}",
              "nativeDeps": "${{ steps.native-deps-cache.outputs.cache-hit == 'true' && 'HIT' || 'MISS' }}"
            }
          }
          EOF

      - name: "üîê Configure AWS Credentials"
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION || 'us-east-1' }}

      - name: "‚òÅÔ∏è Upload to S3"
        id: upload_s3
        run: |
          BUILD_ID="${{ env.BUILD_ID }}"
          S3_BUCKET="${{ secrets.AWS_S3_BUCKET }}"
          S3_PREFIX="builds/${BUILD_ID}"
          ARTIFACT_NAME="${{ env.ARTIFACT_NAME }}"
          
          if [ -z "$S3_BUCKET" ]; then
            echo "‚ùå Error: AWS_S3_BUCKET secret not configured"
            exit 1
          fi
          
          echo "Uploading to S3 bucket: $S3_BUCKET"
          aws s3 cp "artifacts/$ARTIFACT_NAME" "s3://${S3_BUCKET}/${S3_PREFIX}/" --no-progress
          aws s3 cp artifacts/build-info.json "s3://${S3_BUCKET}/${S3_PREFIX}/" --no-progress
          
          APP_DOWNLOAD_URL=$(aws s3 presign "s3://${S3_BUCKET}/${S3_PREFIX}/${ARTIFACT_NAME}" --expires-in 604800)
          INFO_DOWNLOAD_URL=$(aws s3 presign "s3://${S3_BUCKET}/${S3_PREFIX}/build-info.json" --expires-in 604800)
          
          echo "APP_DOWNLOAD_URL=$APP_DOWNLOAD_URL" >> $GITHUB_ENV
          echo "INFO_DOWNLOAD_URL=$INFO_DOWNLOAD_URL" >> $GITHUB_ENV
          echo "‚úÖ Upload complete!"

      - name: "üìä Update Build Status"
        if: always()
        run: |
          BUILD_ID="${{ env.BUILD_ID }}"
          S3_BUCKET="${{ secrets.AWS_S3_BUCKET }}"
          
          if [ "${{ job.status }}" == "success" ]; then
            STATUS="completed"
            CONCLUSION="success"
            MESSAGE="Build completed successfully"
            DOWNLOAD_URL="${APP_DOWNLOAD_URL:-null}"
            INFO_URL="${INFO_DOWNLOAD_URL:-null}"
          else
            STATUS="completed"
            CONCLUSION="failure"
            MESSAGE="Build failed - check logs for details"
            DOWNLOAD_URL="null"
            INFO_URL="null"
          fi
          
          cat > build-status.json << EOF
          {
            "buildId": "$BUILD_ID",
            "status": "$STATUS",
            "conclusion": "$CONCLUSION",
            "message": "$MESSAGE",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "downloadUrl": $DOWNLOAD_URL,
            "infoUrl": $INFO_URL,
            "repository": "${{ github.repository }}",
            "runId": "${{ github.run_id }}",
            "appName": "${{ env.APP_NAME }}",
            "buildType": "${{ env.BUILD_TYPE }}",
            "outputType": "${{ env.OUTPUT_TYPE }}",
            "fileSize": ${{ env.FILE_SIZE || 0 }},
            "cachePerformance": {
              "npm": "${{ steps.npm-cache.outputs.cache-hit == 'true' && 'optimal' || 'fallback' }}",
              "gradle": "${{ steps.gradle-cache.outputs.cache-hit == 'true' && 'optimal' || 'fallback' }}",
              "androidSdk": "${{ steps.android-sdk-cache.outputs.cache-hit == 'true' && 'optimal' || 'fallback' }}",
              "androidBuild": "${{ steps.android-build-cache.outputs.cache-hit == 'true' && 'optimal' || 'fallback' }}",
              "nativeDeps": "${{ steps.native-deps-cache.outputs.cache-hit == 'true' && 'optimal' || 'fallback' }}"
            }
          }
          EOF
          
          if [ -n "$S3_BUCKET" ]; then
            aws s3 cp build-status.json "s3://${S3_BUCKET}/status/${BUILD_ID}.json" --no-progress
          fi

      - name: Make API Request
        run: |
          REPO_NAME=$(echo "${{ github.repository }}" | cut -d'/' -f2)
          API_URL="/api/build/build-status?buildId=${REPO_NAME}&owner=asdfasdfasdfasdfjkl&repo=${REPO_NAME}"
          
          echo "Making request to: ${API_URL}"
          
          curl -X GET \
            -H "Accept: application/json" \
            -H "Content-Type: application/json" \
            "https://qavola.com${API_URL}"

      - name: "üìà Build Summary"
        if: always()
        run: |
          echo "## üöÄ Build Process Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Build Details:" >> $GITHUB_STEP_SUMMARY
          echo "- **Build ID**: ${{ env.BUILD_ID }}" >> $GITHUB_STEP_SUMMARY
          echo "- **App Name**: ${{ env.APP_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Type**: ${{ env.BUILD_TYPE }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Output Type**: ${{ env.OUTPUT_TYPE }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ job.status == 'success' && '‚úÖ Success' || '‚ùå Failed' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ job.status }}" == "success" ]; then
            echo "### üì¶ Build Output:" >> $GITHUB_STEP_SUMMARY
            echo "- **File**: ${{ env.ARTIFACT_NAME }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Size**: $(du -h artifacts/${{ env.ARTIFACT_NAME }} | cut -f1)" >> $GITHUB_STEP_SUMMARY
            if [ -n "${{ env.APP_DOWNLOAD_URL }}" ]; then
              echo "- **Download**: Available via S3" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ‚ö° Cache Performance:" >> $GITHUB_STEP_SUMMARY
          echo "- NPM Dependencies: ${{ steps.npm-cache.outputs.cache-hit == 'true' && '‚úÖ Cache Hit' || '‚ö†Ô∏è  Cache Miss' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Gradle Dependencies: ${{ steps.gradle-cache.outputs.cache-hit == 'true' && '‚úÖ Cache Hit' || '‚ö†Ô∏è  Cache Miss' }}" >> $GITHUB_STEP_SUMMARY  
          echo "- Android SDK: ${{ steps.android-sdk-cache.outputs.cache-hit == 'true' && '‚úÖ Cache Hit' || '‚ö†Ô∏è  Cache Miss' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Android Build Cache: ${{ steps.android-build-cache.outputs.cache-hit == 'true' && '‚úÖ Cache Hit' || '‚ö†Ô∏è  Cache Miss' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Native Dependencies: ${{ steps.native-deps-cache.outputs.cache-hit == 'true' && '‚úÖ Cache Hit' || '‚ö†Ô∏è  Cache Miss' }}" >> $GITHUB_STEP_SUMMARY

      - name: "üì§ Upload Build Artifacts"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: android-build-${{ env.BUILD_ID }}
          path: artifacts/
          retention-days: 7
