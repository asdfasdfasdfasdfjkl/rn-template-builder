name: Enhanced Build Cache Setup

on:
  workflow_dispatch:
    inputs:
      force_refresh:
        description: 'Force refresh all caches'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'

env:
  NODE_VERSION: '18'
  JAVA_VERSION: '17'
  ANDROID_HOME: ${{ github.workspace }}/android-sdk
  ANDROID_SDK_ROOT: ${{ github.workspace }}/android-sdk

jobs:
  setup-cache:
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - name: "ðŸ“¥ Checkout Repository"
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # Node.js Setup with improved caching
      - name: "âš™ï¸ Setup Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'

      - name: "ðŸ“¦ Install NPM Dependencies"
        run: npm ci --legacy-peer-deps --no-audit --no-fund --prefer-offline

      # Java Setup
      - name: "â˜• Setup Java JDK"
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'gradle'

      # Android SDK Setup with proper permissions
      - name: "ðŸ¤– Setup Android SDK"
        uses: android-actions/setup-android@v3
        with:
          android-sdk-directory: ${{ env.ANDROID_HOME }}

      # Cache Android SDK components
      - name: "ðŸ“¦ Cache Android SDK"
        uses: actions/cache@v4
        id: android-sdk-cache
        with:
          path: |
            ${{ env.ANDROID_HOME }}/licenses
            ${{ env.ANDROID_HOME }}/ndk
            ${{ env.ANDROID_HOME }}/platforms
            ${{ env.ANDROID_HOME }}/platform-tools
            ${{ env.ANDROID_HOME }}/build-tools
          key: android-sdk-${{ runner.os }}-v1
          restore-keys: |
            android-sdk-${{ runner.os }}-

      # Make gradlew executable
      - name: "ðŸ”§ Make Gradlew Executable"
        run: chmod +x android/gradlew

      # Fixed: Correct Gradle dependency download
      - name: "â¬‡ï¸ Pre-download Gradle Dependencies"
        run: |
          cd android
          echo "Downloading Gradle dependencies..."
          
          # Download dependencies for all projects and configurations
          ./gradlew androidDependencies \
            --build-cache \
            --no-daemon \
            --quiet \
            --configure-on-demand

      # Create universal pre-build that works with any namespace
      - name: "ðŸ—ï¸ Universal Pre-build for Cache Warming"
        run: |
          echo "Creating universal pre-build configuration..."
          
          # Create a build config that matches template structure
          cat > build-config.json << 'EOF'
          {
            "website_address": "https://example.com",
            "app_name": "TemplateApp",
            "version_code": "1",
            "version_name": "1.0.0",
            "name_space": "com.rn_project_template",
            "has_custom_icon": false,
            "build_type": "release",
            "output_type": "apk",
            "platform": "android",
            "permissions": {},
            "created_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          }
          EOF

          cd android
          
          echo "Building Android app with template structure..."
          export GRADLE_OPTS="-Xmx4g -Dorg.gradle.daemon=false -Dorg.gradle.parallel=true -Dorg.gradle.caching=true"
          
          # Build both variants to cache everything
          ./gradlew clean assembleRelease assembleDebug \
            --build-cache \
            --parallel \
            --no-daemon \
            --configure-on-demand \
            -Dorg.gradle.jvmargs="-Xmx3g -XX:MaxMetaspaceSize=512m"

      # Enhanced Gradle caching
      - name: "ðŸ“¦ Cache Gradle Wrapper and Dependencies"
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/wrapper
            ~/.gradle/caches
            ~/.gradle/daemon
            android/.gradle
            android/app/build
          key: gradle-${{ runner.os }}-${{ hashFiles('android/gradle/wrapper/gradle-wrapper.properties', 'android/**/build.gradle*') }}
          restore-keys: |
            gradle-${{ runner.os }}-

      # Cache build outputs
      - name: "ðŸ“¦ Cache Build Outputs"
        uses: actions/cache@v4
        with:
          path: |
            android/app/build/outputs
            android/app/build/intermediates
            android/app/build/tmp
            android/app/.cxx
          key: build-outputs-${{ runner.os }}-${{ hashFiles('android/app/src/**/*.kt', 'android/app/src/**/*.java') }}
          restore-keys: |
            build-outputs-${{ runner.os }}-

      - name: "âœ… Cache Setup Complete"
        run: |
          echo "## ðŸš€ Enhanced Cache Setup Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**All build caches have been warmed and optimized for fast builds.**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Next builds should complete in 1-2 minutes with proper cache hits." >> $GITHUB_STEP_SUMMARY
